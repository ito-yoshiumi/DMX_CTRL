# テスト手順（DMX機器なし）

DMX機器がない環境でも、マイク入力、スピーカー出力、Unityシーンで動作確認ができます。

## テスト用コンポーネント

以下のコンポーネントが追加されています：

1. **AudioInputVisualizer** - マイク入力のRMS/ピッチをSquareスプライトに可視化
2. **TestScenarioController** - シナリオ実行のテスト用UI（キーボード操作）
3. **DMXDebugLogger** - DMX送信の代わりにログ出力

## セットアップ手順

### 1. シーンにコンポーネントを追加

#### Square1に追加
1. Square1オブジェクトを選択
2. `AudioInputVisualizer`コンポーネントを追加
3. 以下の参照を設定：
   - `AudioInputManager`: 新規GameObjectを作成し、`AudioInputManager`を追加
   - `VolumeToColorMapper`: Square1に自動追加される
   - `PitchToHeightMapper`: Square1に自動追加される
   - `Target Sprite`: Square1のSpriteRendererを設定

#### シナリオテスト用GameObjectを作成
1. 空のGameObjectを作成（名前: "TestController"）
2. `TestScenarioController`コンポーネントを追加
3. `ScenarioRunner`コンポーネントも追加
4. `ScenarioRunner`の参照を設定：
   - `AudioSource`: 新規GameObjectを作成し、`AudioSource`を追加
   - `CuePlayer`: 新規GameObjectを作成し、`CuePlayer`を追加
   - `AudioInputManager`: 上記で作成したものを設定

#### DMXデバッグ用GameObjectを作成（オプション）
1. 空のGameObjectを作成（名前: "DMXDebugLogger"）
2. `DMXDebugLogger`コンポーネントを追加

### 2. AudioInputManagerの設定

1. AudioInputManagerがアタッチされたGameObjectを選択
2. マイクデバイス名を設定（空欄でデフォルトマイクを使用）
3. サンプリングレート: 48000（デフォルト）
4. 分析間隔: 0.03秒（デフォルト）

### 3. ScenarioRunnerの設定

1. `scenarioResource`: "Scenario/scenario_ja"（デフォルト）
2. 各参照を設定（上記参照）

## テスト項目

### テスト1: マイク入力の可視化 ✅ 完了

**確認内容:**
- 5つのSquareがマイク音量に応じて色が変わる（小音量=青、大音量=赤）
- 5つのSquareがピッチに応じて上下に移動する（低音=下、高音=上）

**手順:**
1. 再生ボタンを押す
2. マイクに向かって話す、または音を出す
3. 5つのSquareの色と位置が変化することを確認
4. コンソールにRMS/ピッチのログが出力されることを確認

**期待される動作:**
- 静かな時: Squareは青く、下の方に位置
- 大きな音: Squareは赤く変化
- 高い音: Squareが上に移動
- 低い音: Squareが下に移動

### テスト2: 5つのSquareの五線譜動作 ✅ 完了

**確認内容:**
- 5つのSquare（Square0-4）が同じピッチに反応して上下に移動する
- 音程が高いほど上に、低いほど下に移動する
- 音量に応じて色が変化する
- 無音時は最後の位置を維持する（最上段に戻らない）

**手順:**
1. 再生ボタンを押す
2. マイクに向かって声を出す（80-350Hzの範囲）
3. 5つのSquareが同じ音程に反応して上下に移動することを確認
4. 無音時に最上段に戻らないことを確認

**期待される動作:**
- 高い音（350Hz）: Squareが上段（Y = 3.0）に移動
- 低い音（80Hz）: Squareが下段（Y = 0.0）に移動
- 無音時: 最後の位置を維持
- 範囲外のピッチ（1000Hzなど）: 無視される

### テスト3: シナリオ実行 ✅ 完了

**確認内容:**
- シナリオJSONが読み込まれる
- スペースキーでシナリオが開始/停止する

**手順:**
1. 再生ボタンを押す
2. コンソールに「シナリオ読み込み完了」が表示されることを確認
3. スペースキーを押してシナリオを開始
4. コンソールにシナリオの進行状況が表示されることを確認

**確認結果:**
- ✅ シナリオJSONが読み込まれる（エントリ1-8が読み込まれている）
- ✅ スペースキーでシナリオが開始/停止する（シナリオ開始のログが表示されている）
- ✅ コンソールに「シナリオ読み込み完了」が表示される（エントリが表示されている）
- ✅ コンソールにシナリオの進行状況が表示される（WAV警告、録音開始、再生完了が表示されている）

**注意:**
- WAVファイルがない場合は警告が表示されます（正常）
- TTSサービスがない場合はTTSエントリがスキップされます（正常）

### テスト4: TTS（VOICEVOX/COEIROINK）の動作

**確認内容:**
- TTSエンジンに接続できる
- シナリオ内のTTSエントリが事前合成される
- TTS音声が再生される

**前提条件:**
- VOICEVOXまたはCOEIROINKがインストール・起動されている
- TTSServiceコンポーネントがシーンに追加されている
- ScenarioRunnerの`ttsService`フィールドにTTSServiceが割り当てられている

**手順:**
1. VOICEVOX/COEIROINKを起動
2. Unityエディタで再生ボタンを押す
3. コンソールに「[TTSService] TTSエンジンに接続成功」が表示されることを確認
4. コンソールに「[TTSService] 事前合成開始: X件のテキスト」が表示されることを確認
5. 各テキストのキャッシュ追加ログが表示されることを確認
6. コンソールに「[TTSService] 事前合成完了: X件のクリップをキャッシュ」が表示されることを確認
7. スペースキーを押してシナリオを開始
8. TTSエントリで音声が再生されることを確認

**期待される動作:**
- エンジン接続成功のログが表示される
- 6件のTTSテキストが事前合成される（シナリオ内の`type:"tts"`エントリ）
- 各テキストのキャッシュ追加ログが表示される（例: 「キャッシュ追加: "あなたのあいさつもきかせて。さあマイクのまえにたって" (X.XX秒)」）
- シナリオ実行時にTTS音声が再生される
- 音声の長さに応じて適切な待機時間が設定される

**確認結果:**
- ✅ TTSエンジンに接続成功
- ✅ 事前合成の動作確認（完了）
- ✅ TTS音声の再生確認（完了）

**トラブルシューティング:**
- **接続エラーが表示される場合**
  - VOICEVOX/COEIROINKが起動しているか確認
  - `TTSService`の`Engine Base URL`が正しいか確認（デフォルト: `http://127.0.0.1:50021`）
  - ブラウザで`http://127.0.0.1:50021/speakers`にアクセスしてエンジンが応答するか確認
- **事前合成がスキップされる場合**
  - エンジン接続が失敗している可能性があります（上記を確認）
  - コンソールに警告メッセージが表示されているか確認
- **音声が生成されない場合**
  - `TTSService`の`Speaker ID`が正しいか確認（デフォルト: 0）
  - エンジンの`/speakers`エンドポイントで利用可能な話者IDを確認
  - コンソールにエラーメッセージが表示されているか確認

### テスト5: CuePlayerの動作

**確認内容:**
- JSONキーフレームが読み込まれる
- キーフレームが線形補間される

**手順:**
1. CuePlayerがアタッチされたGameObjectを選択
2. `KineticLightController`への参照を設定
3. シナリオ実行時にCueが再生されることを確認
4. コンソールにCue再生のログが表示されることを確認

**注意:**
- DMX機器がないため、実際のライトは動きません
- ログでDMX値の変化を確認できます

## トラブルシューティング

### マイクが検出されない
- マイクの接続を確認
- マイクの権限を確認（Windowsのプライバシー設定）
- コンソールに「利用可能なマイク一覧」が表示されるか確認

### Square1が動かない
- AudioInputManagerが正しく設定されているか確認
- AudioInputVisualizerの参照が正しく設定されているか確認
- コンソールにエラーがないか確認

### シナリオが実行されない
- ScenarioRunnerの参照が正しく設定されているか確認
- ResourcesフォルダにJSONファイルが存在するか確認
- コンソールにエラーメッセージがないか確認

## 次のステップ

### TTSの動作確認
1. ✅ TTSエンジンへの接続確認（完了）
2. ⏳ 事前合成の動作確認（シナリオ実行時に確認）
3. ⏳ TTS音声の再生確認（シナリオ実行時に確認）

### DMX機器がある環境では：
1. ArtNetClientのIPアドレスを設定
2. KineticLightControllerのfixturesを設定
3. 実際のDMXライトが動作することを確認

